name: Deny Self approvals
description: Deny Self approvals
author: Shunsuke Suzuki
branding:
  icon: shield
  color: purple
inputs:
  github_token:
    description: |
      GitHub Access Token
      pull_requests:write - Dismiss approvals
      contents:read - List commits in pull requests
    required: false
  ignore_not_linked_commit:
    description: |
      Ignore commits not linked to a GitHub User.
    required: false
    default: "false"
outputs:
  has_not_linked_commit:
    description: Whether there are commits not linked to a GitHub User
    value: ${{ steps.deny.outputs.has_not_linked_commit }}
runs:
  using: composite
  steps:
    # Install deny-self-approve by aqua
    - run: echo "value=$GITHUB_ACTION_PATH/aqua/aqua.yaml" >> "$GITHUB_OUTPUT"
      id: aqua_config
      shell: bash
    - uses: aquaproj/aqua-installer@e2d0136abcf70b7a2f6f505720640750557c4b33 # v3.1.1
      with:
        aqua_version: v2.44.1
        skip_install_aqua: "true"
      env:
        AQUA_CONFIG: ${{ steps.aqua_config.outputs.value }}

    - shell: bash
      run: deny-self-approve -v
      env:
        AQUA_CONFIG: ${{ steps.aqua_config.outputs.value }}
        GITHUB_TOKEN: ${{ steps.token.outputs.token }}

    - run: |
        opts=""
        if [ "$IGNORE" = "true" ]; then
          opts="--ignore-not-linked-commit"
        fi
        tempfile=$(mktemp)
        if ! deny-self-approve $opts validate --dismiss 2> >(tee -a "$tempfile" >&2); then
          if grep -q "commit isn't linked to a GitHub User" "$tempfile"; then
            echo "::error:: Commit isn't linked to a GitHub User. Please fix git config. https://docs.github.com/en/pull-requests/committing-changes-to-your-project/troubleshooting-commits/why-are-my-commits-linked-to-the-wrong-user" >&2
            echo "has_not_linked_commit=true" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          echo "::error:: Approval is required from anyone who did not push commits to the pull request https://github.com/suzuki-shunsuke/deny-self-approve-action" >&2
          exit 1
        fi
        if grep -q "commit isn't linked to a GitHub User" "$tempfile"; then
          echo "::warning:: Commit isn't linked to a GitHub User. Please fix git config. https://docs.github.com/en/pull-requests/committing-changes-to-your-project/troubleshooting-commits/why-are-my-commits-linked-to-the-wrong-user" >&2
          echo "has_not_linked_commit=true" >> "$GITHUB_OUTPUT"
        fi
        echo "has_not_linked_commit=false" >> "$GITHUB_OUTPUT"
      shell: bash
      id: deny
      env:
        AQUA_CONFIG: ${{ steps.aqua_config.outputs.value }}
        GITHUB_TOKEN: ${{github.token}}
        IGNORE: ${{inputs.ignore_not_linked_commit}}
